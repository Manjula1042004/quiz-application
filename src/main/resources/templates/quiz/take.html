<!-- File: src/main/resources/templates/quiz/take.html -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="'Take Quiz: ' + ${quiz.title}">Take Quiz</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .timer {
            font-size: 1.5rem;
            font-weight: bold;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
        }
        .timer-warning {
            background-color: #ffc107;
            color: #000;
        }
        .timer-danger {
            background-color: #dc3545;
            color: #fff;
            animation: blink 1s infinite;
        }
        @keyframes blink {
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body>
<!-- Navigation -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
        <a class="navbar-brand" href="/">QuizApp</a>
        <div class="navbar-nav ms-auto">
            <div class="timer me-3" id="timer"></div>
            <a class="nav-link" th:href="@{/dashboard}">Back to Dashboard</a>
        </div>
    </div>
</nav>

<div class="container mt-4">
    <!-- Success/Error Messages -->
    <div th:if="${success}" class="alert alert-success alert-dismissible fade show">
        <span th:text="${success}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    <div th:if="${error}" class="alert alert-danger alert-dismissible fade show">
        <span th:text="${error}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <h1 th:text="${quiz.title}">Quiz Title</h1>
    <p class="lead" th:text="${quiz.description}">Quiz Description</p>

    <form id="quizForm" th:action="@{/attempt/submit}" method="post">
        <input type="hidden" name="attemptId" th:value="${attempt.id}">
        <input type="hidden" name="quizId" th:value="${quiz.id}">
        <input type="hidden" id="timeLimit" th:value="${quiz.timeLimit * 60}">

        <!-- Questions -->
        <div th:if="${quiz.questions != null and not quiz.questions.empty}">
            <div th:each="question, iter : ${quiz.questions}">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>Question <span th:text="${iter.index + 1}">1</span></h5>
                    </div>
                    <div class="card-body">
                        <p th:text="${question.questionText}">Question text</p>

                        <!-- Options - FIXED VERSION -->
                        <div th:each="option, optIter : ${question.options}">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="radio"
                                       th:name="'answers[' + ${question.id} + ']'"
                                       th:value="${optIter.index}"
                                       th:id="${'q' + question.id + 'o' + optIter.index}"
                                       required>
                                <label class="form-check-label" th:for="${'q' + question.id + 'o' + optIter.index}">
                                    <span th:text="${option}">Option text</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Empty State -->
        <div th:if="${quiz.questions == null or quiz.questions.empty}" class="alert alert-warning">
            <i class="fas fa-exclamation-triangle me-2"></i>
            This quiz has no questions yet. Please contact the administrator.
        </div>

        <!-- Submit Button -->
        <div class="text-center mt-4">
            <button type="submit" class="btn btn-primary btn-lg px-5">Submit Quiz</button>
            <a th:href="@{/dashboard}" class="btn btn-secondary btn-lg px-5 ms-2">Cancel</a>
        </div>
    </form>
</div>

<!-- File: src/main/resources/templates/quiz/take.html -->
<!-- Add this section before the form -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="alert alert-info">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Quiz Rules:</strong>
                    <ul class="mb-0">
                        <li>Each question has different point values</li>
                        <li>Questions with more points contribute more to your score</li>
                        <li>Timer will auto-submit when time runs out</li>
                        <li>You can resume if disconnected (answers auto-saved)</li>
                    </ul>
                </div>
                <div class="text-center">
                    <div class="timer bg-primary text-white rounded p-2" id="timer">00:00</div>
                    <small class="text-muted">Time Remaining</small>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-body text-center">
                <h5>Points Summary</h5>
                <div id="pointsDisplay">
                    <div class="spinner-border spinner-border-sm" role="status"></div>
                    Loading points...
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add this JavaScript at the end -->
<script>
    // Auto-save answers to localStorage
    function autoSaveAnswers() {
        const form = document.getElementById('quizForm');
        const formData = new FormData(form);
        const answers = {};

        // Extract answers
        formData.forEach((value, key) => {
            if (key.startsWith('answers[')) {
                const questionId = key.match(/\[(.*?)\]/)[1];
                answers[questionId] = parseInt(value);
            }
        });

        // Save to localStorage
        localStorage.setItem('quiz_answers_' + [[${attempt.id}]], JSON.stringify(answers));
        localStorage.setItem('quiz_last_save_' + [[${attempt.id}]], new Date().toISOString());

        console.log('Auto-saved answers:', answers);
    }

    // Load saved answers
    function loadSavedAnswers() {
        const saved = localStorage.getItem('quiz_answers_' + [[${attempt.id}]]);
        if (saved) {
            const answers = JSON.parse(saved);
            Object.keys(answers).forEach(questionId => {
                const radio = document.querySelector(`input[name="answers[${questionId}]"][value="${answers[questionId]}"]`);
                if (radio) {
                    radio.checked = true;
                }
            });
            console.log('Loaded saved answers');
        }
    }

    // Calculate points as user answers
    function updatePointsDisplay() {
        let totalPoints = 0;
        let answeredPoints = 0;

        // Get all questions from the page
        const questionCards = document.querySelectorAll('.question-card');
        questionCards.forEach(card => {
            // Extract question ID from radio button names
            const radioName = card.querySelector('input[type="radio"]')?.name;
            if (radioName) {
                const questionId = radioName.match(/\[(.*?)\]/)[1];
                const selectedRadio = card.querySelector(`input[name="${radioName}"]:checked`);

                // In real implementation, you'd need to fetch point values from server
                // For now, we'll assume 1 point per question
                totalPoints += 1;
                if (selectedRadio) {
                    answeredPoints += 1;
                }
            }
        });

        document.getElementById('pointsDisplay').innerHTML = `
            <div class="display-4">${answeredPoints}/${totalPoints}</div>
            <small class="text-muted">Points Answered / Total</small>
        `;
    }

    // Beforeunload warning
    let quizSubmitted = false;
    window.addEventListener('beforeunload', function(e) {
        if (!quizSubmitted) {
            // Auto-save before leaving
            autoSaveAnswers();

            // Show warning
            e.preventDefault();
            e.returnValue = 'You have unsaved quiz answers. Are you sure you want to leave?';
            return e.returnValue;
        }
    });

    // Auto-save on answer change
    document.addEventListener('change', function(e) {
        if (e.target.type === 'radio' && e.target.name.startsWith('answers[')) {
            autoSaveAnswers();
            updatePointsDisplay();
        }
    });

    // Form submission
    document.getElementById('quizForm').addEventListener('submit', function(e) {
        e.preventDefault();

        // Count answered questions
        const answered = document.querySelectorAll('input[type="radio"]:checked').length;
        const totalQuestions = document.querySelectorAll('.question-card').length;
        const unanswered = totalQuestions - answered;

        // Show confirmation with details
        if (unanswered > 0) {
            const confirmation = confirm(
                `You have ${unanswered} unanswered question(s) out of ${totalQuestions}.\n\n` +
                `Submit anyway?`
            );

            if (!confirmation) {
                return false;
            }
        }

        quizSubmitted = true;

        // Clear saved answers
        localStorage.removeItem('quiz_answers_' + [[${attempt.id}]]);
        localStorage.removeItem('quiz_last_save_' + [[${attempt.id}]]);

        // Show loading state
        const submitBtn = this.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Grading...';

        // Submit the form
        this.submit();
    });

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Load saved answers
        loadSavedAnswers();
        updatePointsDisplay();

        // Start timer
        const timeLimit = parseInt(document.getElementById('timeLimit').value);
        if (timeLimit > 0) {
            startTimer(timeLimit);
        }

        // Auto-save every 30 seconds
        setInterval(autoSaveAnswers, 30000);
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Timer functionality
    function startTimer(duration) {
        let timer = duration;
        const display = document.getElementById('timer');
        const timerElement = display;

        const interval = setInterval(function () {
            const minutes = Math.floor(timer / 60);
            const seconds = timer % 60;

            const displayMinutes = minutes < 10 ? "0" + minutes : minutes;
            const displaySeconds = seconds < 10 ? "0" + seconds : seconds;

            display.textContent = displayMinutes + ":" + displaySeconds;

            // Update styling based on time remaining
            if (timer <= 300) { // 5 minutes
                timerElement.className = 'timer timer-danger';
            } else if (timer <= 600) { // 10 minutes
                timerElement.className = 'timer timer-warning';
            } else {
                timerElement.className = 'timer bg-primary text-white';
            }

            if (--timer < 0) {
                clearInterval(interval);
                display.textContent = "TIME'S UP!";
                alert("Time's up! Submitting your quiz automatically.");
                document.getElementById('quizForm').submit();
            }
        }, 1000);
    }

    // Start timer when page loads
    document.addEventListener('DOMContentLoaded', function() {
        const timeLimit = parseInt(document.getElementById('timeLimit').value);
        if (timeLimit > 0) {
            startTimer(timeLimit);
        }
    });

    // Form submission confirmation
    document.getElementById('quizForm').addEventListener('submit', function(e) {
        const answered = document.querySelectorAll('input[type="radio"]:checked').length;
        const totalQuestions = document.querySelectorAll('.card.mb-4').length;

        if (answered < totalQuestions) {
            if (!confirm(`You have answered ${answered} out of ${totalQuestions} questions. Are you sure you want to submit?`)) {
                e.preventDefault();
                return;
            }
        }

        // Show loading state
        const submitBtn = this.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Submitting...';
    });
</script>
</body>
</html>