<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="'Edit Quiz: ' + ${quiz.title}">Edit Quiz</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .question-card {
            border: 2px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            background: #f8f9fa;
        }
        .option-row {
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            background: white;
        }
        .correct-answer-label {
            color: #28a745;
            font-weight: bold;
        }
    </style>
</head>
<body>
<!-- Navigation -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
        <a class="navbar-brand" href="/">QuizApp</a>
        <div class="navbar-nav ms-auto">
            <a class="nav-link" th:href="@{/admin/dashboard}">Back to Dashboard</a>
            <a class="nav-link" th:href="@{/logout}">Logout</a>
        </div>
    </div>
</nav>

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-12">
            <div class="card">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h4 class="card-title mb-0" th:text="'Edit Quiz: ' + ${quiz.title}">Edit Quiz</h4>
                    <div>
                        <a th:href="@{/quiz/bulk-import/{id}(id=${quiz.id})}" class="btn btn-sm btn-info me-2">
                            <i class="fas fa-upload me-1"></i> Bulk Import
                        </a>
                        <a th:href="@{/quiz/question-bank(quizId=${quiz.id})}" class="btn btn-sm btn-success">
                            <i class="fas fa-database me-1"></i> Question Bank
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Messages -->
                    <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
                        <span th:text="${success}"></span>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                    <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
                        <span th:text="${error}"></span>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>

                    <!-- Quiz Edit Form -->
                    <form th:action="@{/quiz/update/{id}(id=${quiz.id})}" th:object="${quizDto}" method="post">
                        <div class="mb-4">
                            <h5>Quiz Information</h5>
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="mb-3">
                                        <label for="title" class="form-label">Quiz Title *</label>
                                        <input type="text" class="form-control" id="title" th:field="*{title}" required>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="timeLimit" class="form-label">Time Limit (minutes) *</label>
                                        <input type="number" class="form-control" id="timeLimit" th:field="*{timeLimit}" min="1" max="180" required>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="description" class="form-label">Description</label>
                                <textarea class="form-control" id="description" th:field="*{description}" rows="3"></textarea>
                            </div>

                            <div class="mb-3 form-check">
                                <input type="checkbox" class="form-check-input" id="isTemplate" th:field="*{isTemplate}">
                                <label class="form-check-label" for="isTemplate">
                                    Save as template for future use
                                </label>
                            </div>
                        </div>

                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <button type="submit" class="btn btn-primary btn-lg">Update Quiz</button>
                            <a th:href="@{/admin/dashboard}" class="btn btn-secondary btn-lg ms-2">Cancel</a>
                        </div>
                    </form>

                    <!-- Questions Management Section -->
                    <div class="mt-5">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5>Questions <span class="badge bg-primary" th:text="${quiz.questions != null ? quiz.questions.size() : 0}">0</span></h5>
                            <div>
                                <button type="button" class="btn btn-success btn-sm me-2" data-bs-toggle="modal" data-bs-target="#addQuestionModal">
                                    <i class="fas fa-plus me-1"></i> Add Question
                                </button>
                                <a th:href="@{/quiz/bulk-import/{id}(id=${quiz.id})}" class="btn btn-info btn-sm me-2">
                                    <i class="fas fa-upload me-1"></i> Bulk Import
                                </a>
                                <a th:href="@{/quiz/question-bank(quizId=${quiz.id})}" class="btn btn-outline-primary btn-sm">
                                    <i class="fas fa-database me-1"></i> Add from Bank
                                </a>
                            </div>
                        </div>

                        <!-- Existing Questions Display -->
                        <div th:if="${quiz.questions == null or quiz.questions.empty}" class="text-center py-4">
                            <i class="fas fa-question-circle fa-3x text-muted mb-3"></i>
                            <p class="text-muted">No questions added to this quiz yet.</p>
                        </div>

                        <!-- Existing Questions with Edit Options -->
                        <div th:if="${quiz.questions != null and not quiz.questions.empty}">
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Question</th>
                                        <th>Difficulty</th>
                                        <th>Options</th>
                                        <th>Tags</th>
                                        <th>Actions</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <tr th:each="question, iter : ${quiz.questions}">
                                        <td th:text="${iter.index + 1}">1</td>
                                        <td>
                                            <strong th:text="${question.questionText}"></strong>
                                            <div th:if="${question.explanation}" class="small text-muted">
                                                <em th:text="${question.explanation}"></em>
                                            </div>
                                        </td>
                                        <td>
                                            <span th:switch="${question.difficultyLevel}" class="badge">
                                                <span th:case="EASY" class="badge bg-success">Easy</span>
                                                <span th:case="MEDIUM" class="badge bg-warning">Medium</span>
                                                <span th:case="HARD" class="badge bg-danger">Hard</span>
                                            </span>
                                        </td>
                                        <td>
                                            <small>
                                                <span th:each="option, oIter : ${question.options}">
                                                    <span th:if="${oIter.index == question.correctAnswerIndex}"
                                                          class="text-success fw-bold" th:text="${option}"></span>
                                                    <span th:if="${oIter.index != question.correctAnswerIndex}"
                                                          th:text="${option}"></span>
                                                    <span th:if="${!oIter.last}">, </span>
                                                </span>
                                            </small>
                                        </td>
                                        <td>
                                            <div th:if="${question.tags != null and not question.tags.empty}">
                                                <span th:each="tag : ${question.tags}" class="badge bg-secondary me-1">
                                                    <span th:text="${tag.name}"></span>
                                                </span>
                                            </div>
                                            <span th:if="${question.tags == null or question.tags.empty}" class="text-muted">No tags</span>
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm" role="group">
                                                <button type="button" class="btn btn-outline-primary"
                                                        data-bs-toggle="modal"
                                                        data-bs-target="#editQuestionModal"
                                                        th:attr="data-question-id=${question.id},
                                                                data-question-text=${question.questionText},
                                                                data-question-options=${#strings.listJoin(question.options, '|')},
                                                                data-correct-index=${question.correctAnswerIndex},
                                                                data-difficulty=${question.difficultyLevel},
                                                                data-explanation=${question.explanation},
                                                                data-points=${question.points}">
                                                    <i class="fas fa-edit"></i> Edit
                                                </button>
                                                <form th:action="@{/quiz/question/convert-to-template/{id}(id=${question.id})}"
                                                      method="post"
                                                      class="d-inline">
                                                    <button type="submit"
                                                            class="btn btn-outline-info btn-sm"
                                                            title="Save as Template"
                                                            onclick="return confirm('Convert this question to a template?')">
                                                        <i class="fas fa-clone"></i>
                                                    </button>
                                                </form>
                                                <form th:action="@{/quiz/question/delete/{quizId}/{questionId}(quizId=${quiz.id}, questionId=${question.id})}"
                                                      method="post" class="d-inline">
                                                    <button type="submit" class="btn btn-outline-danger"
                                                            onclick="return confirm('Are you sure you want to delete this question?')">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </form>
                                            </div>
                                        </td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Question Modal -->
<div class="modal fade" id="addQuestionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Question</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form th:action="@{/quiz/question/add/{id}(id=${quiz.id})}" method="post" id="addQuestionForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Question Text *</label>
                        <textarea class="form-control" name="questionText" required
                                  placeholder="Enter your question here..." id="addQuestionText"></textarea>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Difficulty Level</label>
                                <select class="form-select" name="difficultyLevel" id="addDifficultyLevel">
                                    <option value="MEDIUM">Medium</option>
                                    <option value="EASY">Easy</option>
                                    <option value="HARD">Hard</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Points</label>
                                <input type="number" class="form-control" name="points" value="1" min="1" max="10" id="addPoints">
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Tags <small class="text-muted">(Separate with commas)</small></label>
                        <input type="text" class="form-control" name="tags" id="addTags"
                               placeholder="e.g., java, programming, oop">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Explanation</label>
                        <textarea class="form-control" name="explanation" id="addExplanation"
                                  placeholder="Optional explanation for the correct answer..."></textarea>
                    </div>

                    <!-- Dynamic Options Section -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <label class="form-label">Options * <small class="text-muted">(Select the correct answer)</small></label>
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="addOptionToModal()">
                                <i class="fas fa-plus"></i> Add Option
                            </button>
                        </div>

                        <div class="options-container" id="modalOptionsContainer">
                            <!-- Option 1 (Required) -->
                            <div class="option-row mb-2" data-option-index="0">
                                <div class="d-flex align-items-center gap-2">
                                    <div class="form-check">
                                        <input class="form-check-input correct-answer" type="radio"
                                               name="correctAnswerIndex" value="0" required checked>
                                        <label class="form-check-label text-success fw-bold">
                                            ✓ Correct
                                        </label>
                                    </div>
                                    <input type="text" class="form-control option-input"
                                           name="options" placeholder="Option 1" required>
                                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeOptionFromModal(this)" disabled>
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Option 2 (Required) -->
                            <div class="option-row mb-2" data-option-index="1">
                                <div class="d-flex align-items-center gap-2">
                                    <div class="form-check">
                                        <input class="form-check-input correct-answer" type="radio"
                                               name="correctAnswerIndex" value="1" required>
                                        <label class="form-check-label text-success fw-bold">
                                            ✓ Correct
                                        </label>
                                    </div>
                                    <input type="text" class="form-control option-input"
                                           name="options" placeholder="Option 2" required>
                                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeOptionFromModal(this)" disabled>
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="mt-2">
                            <small class="text-muted">Minimum 2 options required. Mark one as correct answer.</small>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Question</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Question Modal -->
<div class="modal fade" id="editQuestionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Question</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form th:action="@{/quiz/question/update/{quizId}/{questionId}(quizId=${quiz.id}, questionId=0)}" method="post" id="editQuestionForm">
                <input type="hidden" name="questionId" id="editQuestionId">

                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Question Text *</label>
                        <textarea class="form-control" name="questionText" required
                                  placeholder="Enter your question here..." id="editQuestionText"></textarea>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Difficulty Level</label>
                                <select class="form-select" name="difficultyLevel" id="editDifficultyLevel">
                                    <option value="MEDIUM">Medium</option>
                                    <option value="EASY">Easy</option>
                                    <option value="HARD">Hard</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Points</label>
                                <input type="number" class="form-control" name="points" value="1" min="1" max="10" id="editPoints">
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Explanation</label>
                        <textarea class="form-control" name="explanation" id="editExplanation"
                                  placeholder="Optional explanation for the correct answer..."></textarea>
                    </div>

                    <!-- Dynamic Options Section for Editing -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <label class="form-label">Options * <small class="text-muted">(Select the correct answer)</small></label>
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="addOptionToEditModal()">
                                <i class="fas fa-plus"></i> Add Option
                            </button>
                        </div>

                        <div class="options-container" id="editOptionsContainer">
                            <!-- Options will be populated dynamically -->
                        </div>

                        <div class="mt-2">
                            <small class="text-muted">Minimum 2 options required. Mark one as correct answer.</small>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Question</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // For Add Question Modal
    let modalOptionCount = 2;

    function addOptionToModal() {
        const optionsContainer = document.getElementById('modalOptionsContainer');
        const optionRow = document.createElement('div');
        optionRow.className = 'option-row mb-2';
        optionRow.setAttribute('data-option-index', modalOptionCount);

        optionRow.innerHTML = `
            <div class="d-flex align-items-center gap-2">
                <div class="form-check">
                    <input class="form-check-input correct-answer" type="radio"
                           name="correctAnswerIndex" value="${modalOptionCount}" required>
                    <label class="form-check-label text-success fw-bold">
                        ✓ Correct
                    </label>
                </div>
                <input type="text" class="form-control option-input"
                       name="options" placeholder="Option ${modalOptionCount + 1}" required>
                <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeOptionFromModal(this)">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;

        optionsContainer.appendChild(optionRow);
        modalOptionCount++;

        if (modalOptionCount > 2) {
            const firstTwoOptions = document.querySelectorAll('#modalOptionsContainer .option-row[data-option-index="0"], #modalOptionsContainer .option-row[data-option-index="1"]');
            firstTwoOptions.forEach(option => {
                const removeBtn = option.querySelector('button');
                removeBtn.disabled = false;
            });
        }
    }

    function removeOptionFromModal(button) {
        const optionRow = button.closest('.option-row');
        const optionsContainer = document.getElementById('modalOptionsContainer');
        const allOptions = optionsContainer.querySelectorAll('.option-row');

        if (allOptions.length <= 2) {
            alert('Minimum 2 options are required.');
            return;
        }

        const removedRadio = optionRow.querySelector('.correct-answer');
        if (removedRadio.checked) {
            const firstOption = optionsContainer.querySelector('.option-row');
            if (firstOption && firstOption !== optionRow) {
                firstOption.querySelector('.correct-answer').checked = true;
            }
        }

        optionRow.remove();
        modalOptionCount--;

        const remainingOptions = optionsContainer.querySelectorAll('.option-row');
        remainingOptions.forEach((row, newIndex) => {
            row.setAttribute('data-option-index', newIndex);

            const radio = row.querySelector('.correct-answer');
            radio.value = newIndex;
        });

        if (remainingOptions.length === 2) {
            remainingOptions.forEach(option => {
                const removeBtn = option.querySelector('button');
                removeBtn.disabled = true;
            });
        }
    }

    document.getElementById('addQuestionModal').addEventListener('hidden.bs.modal', function () {
        document.getElementById('addQuestionForm').reset();

        const optionsContainer = document.getElementById('modalOptionsContainer');
        const allOptions = optionsContainer.querySelectorAll('.option-row');

        allOptions.forEach((option, index) => {
            if (index >= 2) {
                option.remove();
            }
        });

        modalOptionCount = 2;
        const remainingOptions = optionsContainer.querySelectorAll('.option-row');
        remainingOptions.forEach((row, index) => {
            row.setAttribute('data-option-index', index);

            const radio = row.querySelector('.correct-answer');
            radio.value = index;
            if (index === 0) radio.checked = true;

            const input = row.querySelector('input[type="text"]');
            input.placeholder = `Option ${index + 1}`;
            input.value = '';

            const removeBtn = row.querySelector('button');
            removeBtn.disabled = true;
        });
    });

    // FIXED: Submit handler for add question form - NO DUPLICATE OPTIONS
    document.getElementById('addQuestionForm').addEventListener('submit', function(e) {
        e.preventDefault();

        console.log("Form submission started...");

        // Collect all option values from the visible inputs
        const optionInputs = document.querySelectorAll('#modalOptionsContainer input[type="text"]');
        const options = [];
        let hasEmptyRequiredOptions = false;

        // Validate and collect options
        optionInputs.forEach((input, index) => {
            const value = input.value.trim();

            // First two options are required
            if (index < 2 && value === '') {
                hasEmptyRequiredOptions = true;
                input.focus();
            }

            if (value !== '') {
                options.push(value);
            }
        });

        console.log("Collected options:", options);

        // Validate required options
        if (hasEmptyRequiredOptions) {
            alert('Please fill in the first two required options.');
            return false;
        }

        // Validate at least 2 options
        if (options.length < 2) {
            alert('Please fill in at least 2 options.');
            return false;
        }

        // Validate correct answer selection
        const correctAnswerRadio = document.querySelector('#modalOptionsContainer input[name="correctAnswerIndex"]:checked');
        if (!correctAnswerRadio) {
            alert('Please select the correct answer.');
            return false;
        }

        const correctAnswerIndex = parseInt(correctAnswerRadio.value);
        console.log("Correct answer index:", correctAnswerIndex);

        // Validate correct answer is within bounds
        if (correctAnswerIndex < 0 || correctAnswerIndex >= options.length) {
            alert('Selected correct answer is not valid. Please select from the available options.');
            return false;
        }

        // Check for duplicate options
        const uniqueOptions = [...new Set(options)];
        if (uniqueOptions.length !== options.length) {
            alert('Duplicate options are not allowed.');
            return false;
        }

        // ✅ FIX: Remove any existing hidden inputs that might have been added before
        const existingHiddenInputs = this.querySelectorAll('input[type="hidden"][name="options"]');
        existingHiddenInputs.forEach(input => input.remove());

        // ✅ FIX: Instead of adding new inputs, just set the values on existing inputs
        optionInputs.forEach((input, index) => {
            // Keep the original input, just ensure it has the correct name
            input.name = 'options'; // All option inputs should have the same name for Spring to collect them as a list
        });

        // Show loading state
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Adding Question...';

        // ✅ Submit the form WITHOUT adding duplicate hidden inputs
        console.log("Submitting form with options:", options);
        this.submit();
    });

    let editOptionCount = 0;

    const editQuestionModal = document.getElementById('editQuestionModal');
    if (editQuestionModal) {
        editQuestionModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;

            const questionId = button.getAttribute('data-question-id');
            const questionText = button.getAttribute('data-question-text');
            const optionsString = button.getAttribute('data-question-options');
            const correctIndex = button.getAttribute('data-correct-index');
            const difficulty = button.getAttribute('data-difficulty');
            const explanation = button.getAttribute('data-explanation');
            const points = button.getAttribute('data-points');

            const options = optionsString.split('|');
            editOptionCount = options.length;

            const form = document.getElementById('editQuestionForm');
            const quizId = '[[${quiz.id}]]';
            form.action = `/quiz/question/update/${quizId}/${questionId}`;

            document.getElementById('editQuestionId').value = questionId;
            document.getElementById('editQuestionText').value = questionText;
            document.getElementById('editDifficultyLevel').value = difficulty;
            document.getElementById('editPoints').value = points || '1';
            document.getElementById('editExplanation').value = explanation || '';

            const editOptionsContainer = document.getElementById('editOptionsContainer');
            editOptionsContainer.innerHTML = '';

            options.forEach((optionText, index) => {
                const optionRow = document.createElement('div');
                optionRow.className = 'option-row mb-2';
                optionRow.setAttribute('data-option-index', index);

                const isChecked = index == correctIndex;

                optionRow.innerHTML = `
                    <div class="d-flex align-items-center gap-2">
                        <div class="form-check">
                            <input class="form-check-input correct-answer" type="radio"
                                   name="correctAnswerIndex" value="${index}" required
                                   ${isChecked ? 'checked' : ''}>
                            <label class="form-check-label text-success fw-bold">
                                ✓ Correct
                            </label>
                        </div>
                        <input type="text" class="form-control option-input"
                               name="options" value="${optionText}"
                               placeholder="Option ${index + 1}" required>
                        <button type="button" class="btn btn-outline-danger btn-sm"
                                onclick="removeOptionFromEditModal(this)"
                                ${index < 2 ? 'disabled' : ''}>
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;

                editOptionsContainer.appendChild(optionRow);
            });
        });
    }

    function addOptionToEditModal() {
        const optionsContainer = document.getElementById('editOptionsContainer');
        const optionRow = document.createElement('div');
        optionRow.className = 'option-row mb-2';
        optionRow.setAttribute('data-option-index', editOptionCount);

        optionRow.innerHTML = `
            <div class="d-flex align-items-center gap-2">
                <div class="form-check">
                    <input class="form-check-input correct-answer" type="radio"
                           name="correctAnswerIndex" value="${editOptionCount}" required>
                    <label class="form-check-label text-success fw-bold">
                        ✓ Correct
                    </label>
                </div>
                <input type="text" class="form-control option-input"
                       name="options" placeholder="Option ${editOptionCount + 1}" required>
                <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeOptionFromEditModal(this)">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;

        optionsContainer.appendChild(optionRow);
        editOptionCount++;

        if (editOptionCount > 2) {
            const firstTwoOptions = document.querySelectorAll('#editOptionsContainer .option-row[data-option-index="0"], #editOptionsContainer .option-row[data-option-index="1"]');
            firstTwoOptions.forEach(option => {
                const removeBtn = option.querySelector('button');
                removeBtn.disabled = false;
            });
        }
    }

    function removeOptionFromEditModal(button) {
        const optionRow = button.closest('.option-row');
        const optionsContainer = document.getElementById('editOptionsContainer');
        const allOptions = optionsContainer.querySelectorAll('.option-row');

        if (allOptions.length <= 2) {
            alert('Minimum 2 options are required.');
            return;
        }

        const removedRadio = optionRow.querySelector('.correct-answer');
        if (removedRadio.checked) {
            const firstOption = optionsContainer.querySelector('.option-row');
            if (firstOption && firstOption !== optionRow) {
                firstOption.querySelector('.correct-answer').checked = true;
            }
        }

        optionRow.remove();
        editOptionCount--;

        const remainingOptions = optionsContainer.querySelectorAll('.option-row');
        remainingOptions.forEach((row, newIndex) => {
            row.setAttribute('data-option-index', newIndex);

            const radio = row.querySelector('.correct-answer');
            radio.value = newIndex;
        });

        if (remainingOptions.length === 2) {
            remainingOptions.forEach(option => {
                const removeBtn = option.querySelector('button');
                removeBtn.disabled = true;
            });
        }
    }

    document.getElementById('editQuestionForm').addEventListener('submit', function(e) {
        const optionInputs = document.querySelectorAll('#editOptionsContainer input[type="text"]');
        let filledOptions = 0;

        optionInputs.forEach((input) => {
            if (input.value.trim() !== '') {
                filledOptions++;
            }
        });

        if (filledOptions < 2) {
            e.preventDefault();
            alert('Please fill in at least 2 options.');
            return false;
        }

        const correctAnswerSelected = document.querySelector('#editOptionsContainer input[name="correctAnswerIndex"]:checked');
        if (!correctAnswerSelected) {
            e.preventDefault();
            alert('Please select the correct answer.');
            return false;
        }

        const optionValues = Array.from(optionInputs)
            .map(opt => opt.value.trim().toLowerCase())
            .filter(val => val !== '');
        const uniqueValues = new Set(optionValues);

        if (uniqueValues.size !== optionValues.length) {
            e.preventDefault();
            alert('Duplicate options are not allowed.');
            return false;
        }
    });
</script>
</body>
</html>